<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<link rel="icon" type="image/svg+xml" href="/vite.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Vite + Lit + TS</title>
		<link rel="stylesheet" href="./src/index.css" />
	</head>

	<body>
		<aside>
			<div>
				<h2>Comicbook</h2>
				<p>Version: 0.1.0</p>
			</div>
		</aside>

		<main>
			<h1>Preview</h1>

			<div class="preview"></div>
		</main>

		<script type="module">
			import { html, render } from 'lit'
			const loadedStories = []

			// Load all possible stories
			const modules = import.meta.glob('./src/components/**/*.stories.ts', { eager: true })
			for (const path in modules) {
				loadedStories.push({
					path,
					name: path.match(/(?<=\.\/src\/components\/)([a-zA-Z-]*)/)[0],
					stories: modules[path],
				})
			}

			// Display all components in a list with their respective stories
			loadedStories.forEach((file) => {
				document.querySelector('aside').innerHTML += `<h3>${file.name}</h3>`
				Object.keys(file.stories).forEach((storyName) => {
					document.querySelector('aside').innerHTML += `<a href="/${file.name}/${storyName}">${storyName}</a>`
				})
			})

			// Function to handle link clicks and page loads. Loads the story from route and renders it.
			function renderStory(event) {
				try {
					// Stop default full page load
					event?.preventDefault()
					// Set title and route, if event was triggered by link
					if (event?.target) history.pushState({}, '', event.target.href)

					// Extract component and story name from path
					const [_, componentName, storyName] = location.pathname.split('/')
					// If invalid route, return
					if (!componentName || !storyName) throw Error('Invalid route')

					// Find component and story
					const component = loadedStories.find((s) => s.name === componentName)
					if (!component) throw Error('Component not found')
					const story = component.stories[storyName]
					if (!story) throw Error('Story not found')

					// Render story inside preview div
					render(story(), document.body.querySelector('.preview'))
				} catch (error) {
					console.error(error)
					render(`${error}`, document.body.querySelector('.preview'))
				}
			}

			// Handle route load and change
			window.addEventListener('load', () => renderStory())
			document.querySelectorAll('aside a').forEach((a) => a.addEventListener('click', renderStory))
		</script>
	</body>
</html>
